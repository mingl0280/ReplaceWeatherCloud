<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WeatherDataDetails</title>
    <!-- vue.js display library -->
    <script src="/static/js/vue.js"></script>
    <!-- composition-api library -->
    <script src="/static/js/composition-api-1.4.3.js"></script>
    <!-- echarts library -->
    <script src="/static/js/echarts-5.2.2.js"></script>
    <!-- vue-echarts.js library -->
    <script src="/static/js/vue-echarts-6.0.2.js"></script>
    <!-- axios.js async query js library -->
    <script src="/static/js/axios.js"></script>
    <!-- bootstrap 3 dynamic component library (used for single-page navigation) -->
    <script src="/static/js/bootstrap.js"></script>
    <!-- Save a file to local library -->
    <script src="/static/js/FileSaver.js"></script>
    <!-- Moment.js -->
    <script src="/static/js/moment.js"></script>
    <!-- bootstrap 3 style sheet -->
    <link href="/static/css/bootstrap.css" rel="stylesheet">

    <!-- Fonts
    Warning: Fonts are for personal use only!
     -->

    <link href="/static/css/led-counter-7.css" rel="stylesheet">
    <link href="/static/css/digital_counter_7.css" rel="stylesheet">
    <link href="static/css/page_custom_styles.css" rel="stylesheet"/>
</head>
<body>
<div class="box-center">
    <form class="card_piece">
        <div id="lang_select">
            <button type="button" class="btn btn-outline-primary lang_lst" onclick="ChangeLang(this)" optData="en">
                English
            </button>
            <button type="button" class="btn btn-outline-primary lang_lst" onclick="ChangeLang(this)" optData="zhs">
                简体中文
            </button>
        </div>
    </form>
    <a id="time-data-page-link" href="/">{{trns.main_text}}</a>
    <form class="card_piece">
        <div id="altitude_input" class="form-row">
            <div class="form-group" style="display: inline">
                <div class="row-no-margin">
                    <div class="col-hint-1">
                        <label for="altitude_value_input" class="vert-align-middle"
                               style="min-width: 7.165em;">{{trns.altitude_text}}:</label>
                    </div>
                    <div class="inline-inputs-less">
                        <input type="number" class="form-control vert-align-middle"
                               id="altitude_value_input" v-bind:placeholder="trns.altitude_alt_text" />
                    </div>
                    <div class="col-btn-1">
                        <button type="button" class="btn btn-success vert-align-middle" onclick="UpdateAltitude()"
                                style="display: inline;">{{trns.set_text}}
                        </button>
                    </div>
                </div>
                <div class="row-no-margin">
                    <div class="col-hint-1">
                        <label class="vert-align-middle" style="min-width: 7.165em;">
                            {{trns.temp_select_text}}
                        </label>
                    </div>
                    <div class="select-group">
                        <div class="radio-btn-group">
                            <input type="radio" id="temp_unit_celsius" name="temp_unit_opts"
                                   value="0" onchange="UpdateTempUnit(0)" checked="checked"/>
                            <label for="temp_unit_celsius">{{trns.temp_unit_celsius}}</label>
                        </div>
                        <div class="radio-btn-group">
                            <input type="radio" id="temp_unit_fahrenheit" name="temp_unit_opts"
                                   value="1" onchange="UpdateTempUnit(1)"/>
                            <label
                                    for="temp_unit_fahrenheit">{{trns.temp_unit_fahrenheit}}</label>
                        </div>
                        <div class="radio-btn-group">
                            <input type="radio" id="temp_unit_kelvin" name="temp_unit_opts"
                                   value="2" onchange="UpdateTempUnit(2)"/>
                            <label for="temp_unit_kelvin">{{trns.temp_unit_kelvin}}</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <form class="card_piece">
        <div id="time_selection_overall">
            <div class="form-group" style="display: inline">
                <div class="row-no-margin">
                    <div class="col-hint-1">
                        <label for="start_date_time">{{trns.start_date_time_alt_text}}:</label>
                    </div>
                    <div class="inline-inputs">
                        <input type="datetime-local" class="form-control" id="start_date_time"
                               v-model="start_date_time" @change="checkdate()">
                        <label style="color: red">{{start_datetime_err_msg}}</label>
                    </div>
                    <br/>
                    <div class="col-hint-1">
                        <label for="end_date_time">{{trns.end_date_time_alt_text}}:</label>
                    </div>
                    <div class="inline-inputs">
                        <input type="datetime-local" class="form-control" id="end_date_time"
                               v-model="end_date_time" @change="checkdate()">
                        <label style="color: red">{{end_datetime_err_msg}}</label>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div id="WindRose">
        <v-chart autoresize :option="option"/>
    </div>
    <br/>
    <div id="WindPict">
        <v-chart autoresize :option="option"/>
    </div>
    <br/>
    <div id="RainPict">
        <v-chart autoresize :option="option"/>
    </div>
    <div id="TempPict">
        <v-chart autoresize :option="option"/>
    </div>
    <div id="SolarPict">
        <v-chart autoresize :option="option"/>
    </div>
    <div id="BaroPict">
        <v-chart autoresize :option="option"/>
    </div>
</div>
</body>
</html>

<script lang="javascript">
    Vue.component("v-chart", VueECharts)

    /* ================================
     *       Variables
     * ================================ */

    let cached_current_btn, cached_days, cached_hours;
    const cached_start_time = 0, cached_end_time = 1;
    let cached_wind_btn;
    const cached_altitude = 0

    ;

    const cached_selected_temp_symbol = "iso";

    const cached_selected_wind_symbol = "sea_knots";

    /* ================================
     *       Constants
     * ================================ */

    const legendNames = {
        en: {
            meterPerSecond: [
                "0.0-0.2 m/s",
                "0.3-1.5 m/s",
                "1.6-3.3 m/s",
                "3.4-5.4 m/s",
                "5.5-7.9 m/s",
                "8.0-10.7 m/s",
                "10.8-13.8 m/s",
                "13.9-17.1 m/s",
                "17.2-20.7 m/s",
                "20.8-24.4 m/s",
                "24.5-28.4 m/s",
                "28.5-32.6 m/s",
                ">32.6 m/s"
            ],
            knots: [
                "0-0.39 Knots",
                "0.58-2.92 Knots",
                "3.11-6.41 Knots",
                "6.61-10.5 Knots",
                "10.69-15.36 Knots",
                "15.55-20.8 Knots",
                "20.99-26.83 Knots",
                "27.02-33.24 Knots",
                "33.43-40.24 Knots",
                "40.43-47.43 Knots",
                "47.62-55.21 Knots",
                "55.4-63.37 Knots",
                "63.56-71.73 Knots",
                "> 71.73 Knots"
            ]
        },
        zh: {
            meterPerSecond: [
                "0.0-0.2 m/s",
                "0.3-1.5 m/s",
                "1.6-3.3 m/s",
                "3.4-5.4 m/s",
                "5.5-7.9 m/s",
                "8.0-10.7 m/s",
                "10.8-13.8 m/s",
                "13.9-17.1 m/s",
                "17.2-20.7 m/s",
                "20.8-24.4 m/s",
                "24.5-28.4 m/s",
                "28.5-32.6 m/s",
                ">32.6 m/s"
            ],
            knots: [
                "0-0.39 节",
                "0.58-2.92 节",
                "3.11-6.41 节",
                "6.61-10.5 节",
                "10.69-15.36 节",
                "15.55-20.8 节",
                "20.99-26.83 节",
                "27.02-33.24 节",
                "33.43-40.24 节",
                "40.43-47.43 节",
                "47.62-55.21 节",
                "55.4-63.37 节",
                "63.56-71.73 节",
                "> 71.73 节"
            ]
        }

    };

    const vocs = [
        "0.3 mg/m³",
        "0.4 mg/m³",
        "0.3 mg/m³",
        "0.3 mg/m³",
        "0.5 mg/m³",
        "0.23 mg/m³",
        "0.2 mg/m³",
        "0.7 mg/m³",
        "0.6 mg/m³",
        "0.2 mg/m³",
        "0.1 mg/m³",
        "0.1 mg/m³",
        "0.6 mg/m³",

    ];

    const generic_info_trns = {
        "en": {
            feels_like: "Feels like",
            tag_text_wind_chill: "Wind Chill",
            tag_text_outdoor: "Normal Outdoor Temp",
            tag_text_heat_idx: "Heat Index",
            tag_text_thwindex: "THW Index",
            report_created: "Report Created",
            indoor: "Indoor",
            outdoor: "Outdoor",
            dew_point: "Dew point",
            pressure: "Pressure",
            wind: {
                normal: "Wind",
                gust: "Gust",
                average: "Average",
                from: "From"
            },
            rain: "Rain (last hour)",
            rain_24h: "24h Total",
            no_rain: "No Rain",
            heat: "Heat",
            heat_idx: "Heat Index",
            thwindex: "THW Index",
            solar: "Solar Power",
            uvindex: "UV Index",
            hour: "hr",
            knots: "kn",
            altitude_alt_text: "Altitude in meters, e.g. 1002",
            altitude_text: "Altitude",
            set_text: "Set",
            main_text: "Return to main page",
            time_opt_text: "Time Options",
            start_date_time_alt_text: "Start Date and Time",
            end_date_time_alt_text: "End Date and Time",
            not_earlier_than: "cannot be earlier than",
            not_later_than: "cannot be later than",
            today_text: "today",
            time_diff_between_text: "Time difference between start and end time cannot be longer than",
            hours_text: "hours",
            temp_select_text: "Temperature Unit: ",
            temp_unit_celsius: "Celsius (℃)",
            temp_unit_fahrenheit: "Fahrenheit (℉)",
            temp_unit_kelvin: "Kelvin (K)",
        },
        "zhs": {
            feels_like: "体感温度",
            tag_text_wind_chill: "风寒指数",
            tag_text_outdoor: "室外气温",
            tag_text_heat_idx: "高温指数",
            tag_text_thwindex: "体感温度指数(THW指数)",
            report_created: "报告时间",
            indoor: "室内",
            outdoor: "室外",
            dew_point: "露点温度",
            pressure: "气压",
            wind: {
                normal: "风力指标",
                gust: "阵风",
                average: "平均风速",
                from: "风向"
            },
            rain: "近1小时雨量",
            rain_24h: "24小时雨量",
            no_rain: "无雨",
            heat: "高温",
            heat_idx: "高温指数",
            thwindex: "体感温度",
            solar: "太阳辐射功率",
            uvindex: "紫外线指数",
            hour: "小时",
            knots: "节",
            altitude_alt_text: "海拔高度，例如1002",
            altitude_text: "海拔",
            set_text: "设置",
            time_opt_text: "时间选项",
            main_text: "回主页",
            start_date_time_alt_text: "开始日期和时间",
            end_date_time_alt_text: "结束日期和时间",
            not_earlier_than: "不能早于",
            not_later_than: "不能晚于",
            today_text: "今天",
            time_diff_between_text: "开始和结束时间的差异不能超过",
            hours_text: "小时",
            temp_select_text: "温度单位: ",
            temp_unit_celsius: "摄氏度 (℃)",
            temp_unit_fahrenheit: "华氏度 (℉)",
            temp_unit_kelvin: "开尔文 (K)",
        }
    };

    const time_label_trns = {
        "en": {
            all: "All",
            hr: " Hour",
            hrs: " Hours",
            day: " Day",
            days: " Days"
        },
        "zhs": {
            all: "全部时间段",
            hr: "小时内",
            hrs: "小时内",
            day: "天内",
            days: "天内"
        }
    };

    const dims = {
        time: 0, windSpeed: 1, R: 2, gust: 3, gust_filtered: 4, actual_speed: 5, angle_type: 6, angle_value: 7
    };

    const other_dims = {
        time: 0, data_raw_item: 1, data_smoothed: 2,
    };

    const temp_dims = {
        time: 0, temp_out: 1, temp_in: 2
    };

    const baro_dims = {
        time: 0, baro: 1, raw_baro: 2
    };

    const wind_angle_types = {
        "en": {
            0: "N",
            1: "NNE",
            2: "NE",
            3: "ENE",
            4: "E",
            5: "ESE",
            6: "SE",
            7: "SSE",
            8: "S",
            9: "SSW",
            10: "SW",
            11: "WSW",
            12: "W",
            13: "WNW",
            14: "NW",
            15: "NNW"
        }, "zhs": {
            0: "正北",
            1: "北北东",
            2: "东北",
            3: "东东北",
            4: "东",
            5: "东东南",
            6: "东南",
            7: "南东南",
            8: "南",
            9: "南西南",
            10: "西南",
            11: "西西南",
            12: "西",
            13: "西西北",
            14: "西北",
            15: "北西北"
        }
    };

    const wind_angle_list_types = {
        "en": ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"],
        "zhs": ["正北", "北北东", "东北", "东东北", "东", "东东南", "东南", "南东南", "南", "南西南", "西南", "西西南", "西", "西西北", "西北", "北西北"]
    };

    const wind_tooltip_translate = {
        "en": {
            title: "Wind Speed",
            speed: "Speed",
            dir: "Direction",
            dir_value: "Dir Value",
            gust: "Gust",
            knts: " Knots"
        },
        "zhs": {
            title: "风速分析图",
            speed: "速度",
            dir: "方向",
            dir_value: "方位角",
            gust: "阵风",
            knts: "节"
        }
    };

    const other_tooltip_translate = {
        "en": {
            mmhr: "mm/hr",
            inhr: "in/hr",
            rain_tooltip_name: "Depth",
            rain_title: "Rain history",
            temp_out: "Outdoor Temperature",
            temp_in: "Indoor Temperature",
            temp_title: "Temperature",
            solar_tooltip_name: "Power",
            solar_title: "Solar Radiation",
            barometer: "Barometer",
            barometer_title: "Barometer History",
            current_baro: "Current air pressure",
            barometer_avg: "30-min moving average",
            smoothed: "(smoothed)",

        },
        "zhs": {
            mmhr: "毫米/小时",
            inhr: "英寸/小时",
            rain_tooltip_name: "雨量",
            rain_title: "雨量历史",
            temp_out: "室外温度",
            temp_in: "室内温度",
            temp_title: "温度图",
            solar_tooltip_name: "功率",
            solar_title: "太阳辐射量",
            barometer: "气压",
            barometer_title: "气压表",
            current_baro: "当前气压",
            barometer_avg: "30分钟平均气压",
            smoothed: "(平滑)",
        }
    };

    const arrowSize = 16;

    /* ================================
     *       Helper Functions
     * ================================ */

    function renderArrow(param, api) {
        const point = api.coord([
            api.value(dims.time),
            api.value(dims.windSpeed)
        ]);
        return {
            type: 'path',
            shape: {
                pathData: 'M31 16l-15-15v9h-26v12h26v9z',
                x: -arrowSize / 2,
                y: -arrowSize / 2,
                width: arrowSize,
                height: arrowSize
            },
            rotation: api.value(dims.R),
            position: point,
            style: api.style({
                stroke: '#555',
                lineWidth: 1
            })
        };
    }


    /* ================================
     *       Vue.js Templates
     * ================================ */

    const windrose = new Vue({
        el: "#WindRose",
        data: function () {
            return {
                option: {
                    tooltip: {
                        trigger: 'item',
                        textStyle: {
                            color: '#000000'
                        }
                    },
                    color: [
                        "#0001F7", // 0-0.2
                        "#00DCFF", // 0.3-1.5
                        "#00FFFF", // 1.6-3.3
                        "#00FF68", // 3.4-5.4
                        "#5FFF34", // 5.5-7.9
                        "#BEFE00", // 8.0-10.7
                        "#DFFF00", // 13.8
                        "#FFFF00", // 17.1
                        "#FFD400", // 20.7
                        "#FFA800", // 24.4
                        "#F05500", // 28.4
                        "#E10100", // 32.6
                        "#E41817", // >
                    ],
                    grid: {
                        left: 0,
                        right: 0
                    },
                    angleAxis: {
                        type: 'category',
                        data: wind_angle_list_types.en,
                        boundaryGap: false, //标签和数据点都会在两个刻度之间的带(band)中间
                        axisTick: {
                            show: false //是否显示坐标轴刻度
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                // color:"black"
                            },
                        },
                        axisLabel: {
                            show: true,
                            interval: 1, //坐标轴刻度标签的显示间隔，在类目轴中有效
                        },
                    },
                    radiusAxis: {
                        min: 0,
                        max: 100,
                        axisLabel: {
                            show: false
                        },
                        axisTick: {
                            show: false //是否显示坐标轴刻度
                        },
                        axisLine: {
                            show: false //是否显示坐标轴轴线
                        },
                    },
                    polar: {},
                    series: [],
                    legend: {
                        show: true,
                        data: legendNames.en.meterPerSecond,
                        top: 'center',
                        right: 1,
                        orient: 'vertical'
                    }
                }
            }
        },
        methods: {
            async fetch_data(startTime, endTime) {
                const opts = [
                    "startTime=" + startTime,
                    "endTime=" + endTime
                ];

                const args = opts.join("&");
                let out_data;
                await axios.get("/api/ByTime/wind/rosemap?" + args).then(function (result) {
                    out_data = result.data
                })
                this.option.series = out_data;
                let data_counter_max = [];
                for (let i = 0; i < out_data[0].data.length; i++)
                    data_counter_max[i] = 0;

                for (let i = 0; i < out_data.length; i++) {
                    for (let j = 0; j < out_data[i].data.length; j++) {
                        data_counter_max[j] += out_data[i].data[j];
                    }
                }
                let total_max = 0;
                for (let i = 0; i < data_counter_max.length; i++) {
                    if (data_counter_max[i] > total_max)
                        total_max = data_counter_max[i];
                }
                this.option.radiusAxis.max = Math.round(Math.pow(2, Math.log2(total_max) + 0.1) + 1)
            }
        }
    });

    const wind_analyze = new Vue({
        el: "#WindPict",
        data: function () {
            return {
                option: {
                    title: {
                        text: 'Wind Speed',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const cached_trn_name = localStorage.getItem('trn_name');
                            return [
                                echarts.format.formatTime('yyyy-MM-dd', params[0].value[dims.time])
                                + ' ' + echarts.format.formatTime('hh:mm', params[0].value[dims.time]),
                                wind_tooltip_translate[cached_trn_name].speed + ": " +
                                params[0].value[dims.actual_speed] + wind_tooltip_translate[cached_trn_name].knts,
                                wind_tooltip_translate[cached_trn_name].dir + ": " +
                                wind_angle_types[cached_trn_name][params[0].value[dims.angle_type]],
                                wind_tooltip_translate[cached_trn_name].dir_value + ": " +
                                params[0].value[dims.angle_value],
                                wind_tooltip_translate[cached_trn_name].gust + ": " +
                                params[0].value[dims.gust] + wind_tooltip_translate[cached_trn_name].knts
                            ].join('<br>');
                        }
                    },
                    grid: {
                        top: 40,
                        bottom: 60,
                        right: 10
                    },
                    xAxis: {
                        type: 'time'
                    },
                    yAxis: [{
                        name: 'Wind Speed (Kn)',
                        nameLocation: 'middle',
                        nameGap: 35,
                        axisLine: {
                            lineStyle: {
                                color: '#666'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#ddd'
                            }
                        }
                    }, {
                        axisLine: {show: false},
                        axisTick: {show: false},
                        axisLabel: {show: false},
                        splitLine: {show: false}
                    }],
                    visualMap: {
                        type: 'piecewise',
                        orient: 'horizontal',
                        left: 'center',
                        bottom: 10,
                        pieces: [{
                            gte: 17,
                            color: '#D33C3E',
                            label: '>17 Knots'
                        }, {
                            gte: 11,
                            lt: 17,
                            color: '#ffff00',
                            label: '11 - 17 Knots'
                        }, {
                            lt: 11,
                            color: '#18BF12',
                            label: '< 11 Knots'
                        }],
                        seriesIndex: 0,
                        dimension: dims.actual_speed
                    },
                    dataZoom: [{
                        type: 'inside',
                        xAxisIndex: 0,
                        minSpan: 5
                    }],
                    series: [{
                        type: 'custom',
                        renderItem: renderArrow,
                        encode: {
                            x: dims.time,
                            y: dims.windSpeed
                        },
                        data: [],
                        smooth: false,
                        z: 10
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: dims.time,
                            y: dims.windSpeed
                        },
                        lineStyle: {
                            normal: {
                                color: 'green',
                                type: 'solid'
                            }
                        },
                        smooth: true,
                        data: [],
                        z: 4
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: dims.time,
                            y: dims.gust_filtered
                        },
                        data: [],
                        smooth: true,
                        lineStyle: {
                            normal: {
                                color: '#66ccff',
                                type: 'solid'
                            }
                        }, z: 3
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: dims.time,
                            y: dims.actual_speed
                        },
                        data: [],
                        smooth: false,
                        lineStyle: {
                            normal: {
                                color: '#ff9f63',
                                type: 'dashed'
                            }
                        }, z: 2
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: dims.time,
                            y: dims.gust
                        },
                        data: [],
                        smooth: false,
                        lineStyle: {
                            normal: {
                                color: '#ffcbaf',
                                type: 'dashed'
                            }
                        }, z: 1
                    }]
                }
            }
        },
        methods:
            {
                async fetch_data(start_time, end_time) {
                    let out_data;
                    const opts = [
                        "startTime=" + start_time,
                        "endTime=" + end_time
                    ];

                    const args = opts.join("&");

                    await axios.get("/api/ByTime/wind?" + args).then(function (result) {
                        out_data = result.data
                    })

                    this.option.series[0].data = out_data;
                    this.option.series[1].data = out_data;
                    this.option.series[2].data = out_data;
                    this.option.series[3].data = out_data;
                    this.option.series[4].data = out_data;
                },
                set_translate_objects(trans_name) {
                    this.option.title.text = wind_tooltip_translate[trans_name].title;
                    this.$forceUpdate();
                }
            }
    });

    const RainPict = new Vue({
        el: "#RainPict",
        data: function () {
            return {
                option: {
                    title: {
                        text: other_tooltip_translate["en"].rain_title,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const cached_trn_name = localStorage.getItem('trn_name');
                            return [
                                echarts.format.formatTime('yyyy-MM-dd', params[0].value[other_dims.time])
                                + ' ' + echarts.format.formatTime('hh:mm', params[0].value[other_dims.time]),
                                /* Raw value */
                                other_tooltip_translate[cached_trn_name].rain_tooltip_name + ': ' +
                                params[0].value[other_dims.data_raw_item].toString() + ' ' +
                                other_tooltip_translate[cached_trn_name].mmhr,
                                /* Smoothed value */
                                other_tooltip_translate[cached_trn_name].rain_tooltip_name + ' ' +
                                other_tooltip_translate[cached_trn_name].smoothed + ': ' +
                                params[0].value[other_dims.data_smoothed].toString() + ' ' +
                                other_tooltip_translate[cached_trn_name].mmhr
                            ].join('<br>');
                        }
                    },
                    grid: {
                        top: 40,
                        bottom: 60,
                        right: 0
                    },
                    xAxis: {
                        type: 'time'
                    },
                    yAxis: [{
                        name: 'Value',
                        nameLocation: 'middle',
                        nameGap: 35,
                        axisLine: {
                            lineStyle: {
                                color: '#666'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#ddd'
                            }
                        }
                    }, {
                        axisLine: {show: false},
                        axisTick: {show: false},
                        axisLabel: {show: false},
                        splitLine: {show: false}
                    }],
                    dataZoom: [{
                        type: 'inside',
                        xAxisIndex: 0,
                        minSpan: 5
                    }],
                    series: [{
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: other_dims.time,
                            y: other_dims.data_raw_item
                        },
                        lineStyle: {
                            normal: {
                                color: '#8c8c8c',
                                type: 'solid'
                            }
                        },
                        smooth: true,
                        data: [],
                        z: 1
                    },
                        {
                            type: 'line',
                            symbol: 'none',
                            encode: {
                                x: other_dims.time,
                                y: other_dims.data_smoothed
                            },
                            lineStyle: {
                                normal: {
                                    color: 'blue',
                                    type: 'solid'
                                }
                            },
                            smooth: true,
                            data: [],
                            z: 1
                        }]
                }
            }
        },
        methods:
            {
                async fetch_data(startTime, endTime) {
                    const opts = [
                    "startTime=" + startTime,
                    "endTime=" + endTime
                    ];

                    const args = opts.join("&");
                    let out_data;

                    await axios.get("/api/ByTime/rain?" + args).then(function (result) {
                        out_data = result.data
                    })
                    this.option.series[0].data = out_data;
                    this.option.series[1].data = out_data;
                },
                set_translate_objects(trans_name) {
                    this.option.title.text = other_tooltip_translate[trans_name].rain_title;
                    this.$forceUpdate();
                }
            }
    });

    const TempPict = new Vue({
        el: "#TempPict",
        data: function () {
            return {
                option: {
                    title: {
                        text: other_tooltip_translate["en"].temp_title,
                        left: 'center',
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const cached_trn_name = localStorage.getItem('trn_name');
                            return [
                                echarts.format.formatTime('yyyy-MM-dd', params[0].value[temp_dims.time])
                                + ' ' + echarts.format.formatTime('hh:mm', params[0].value[temp_dims.time]),
                                other_tooltip_translate[cached_trn_name].temp_out + ': ' +
                                params[0].value[temp_dims.temp_out].toString() + '℃',
                                other_tooltip_translate[cached_trn_name].temp_in + ": " +
                                params[0].value[temp_dims.temp_in].toString() + '℃'
                            ].join('<br>');
                        }
                    },
                    grid: {
                        top: 60,
                        bottom: 60
                    },
                    xAxis: {
                        type: 'time'
                    },
                    yAxis: [{
                        name: 'Value',
                        nameLocation: 'middle',
                        nameGap: 35,
                        axisLine: {
                            lineStyle: {
                                color: '#666'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#ddd'
                            }
                        },
                        scale: true
                    }, {
                        axisLine: {show: false},
                        axisTick: {show: false},
                        axisLabel: {show: false},
                        splitLine: {show: false}
                    }],
                    visualMap: [{
                        type: 'continuous',
                        align: 'center',
                        left: 'right',
                        top: 'top',
                        orient: 'vertical',
                        itemWidth: 55,
                        itemHeight: 100,
                        text: [],
                        min: 0,
                        max: 30,
                        dimension: temp_dims.temp_out,
                        inRange: {
                            color: ['#009112', '#ffff00', '#ff5500']
                        },
                    }, {
                        type: 'continuous',
                        align: 'center',
                        orient: 'vertical',
                        itemWidth: 55,
                        itemHeight: 100,
                        text: [],
                        left: 'right',
                        min: 5,
                        max: 25,
                        dimension: temp_dims.temp_in,
                        inRange: {
                            color: ['#009112', '#ffff00', '#ff5500']
                        },
                    }],
                    dataZoom: [{
                        type: 'inside',
                        xAxisIndex: 0,
                        minSpan: 5
                    }],
                    series: [{
                        type: 'line',
                        symbol: 'none',
                        lineStyle: {
                            normal: {
                                type: 'dotted'
                            }
                        },
                        encode: {
                            x: temp_dims.time,
                            y: temp_dims.temp_out
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: 'Max', itemStyle: {color: '#ff7300'}},
                                {type: 'min', name: 'Min', itemStyle: {color: '#0486ad'}}
                            ]
                        },
                        smooth: true,
                        data: [],
                        z: 1
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: temp_dims.time,
                            y: temp_dims.temp_in
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: 'Max', itemStyle: {color: '#ff7300'}},
                                {type: 'min', name: 'Min', itemStyle: {color: '#0486ad'}}
                            ]
                        },
                        smooth: true,
                        data: [],
                        z: 2
                    }]
                }
            }
        },
        methods:
            {
                async fetch_data(start_time, end_time) {
                    let target_lang = localStorage.getItem('trn_name');
                    if (target_lang == "null") {
                        target_lang = "en";
                    }
                    let out_data;
                    const opts = [
                        "startTime=" + start_time,
                        "endTime=" + end_time,
                    ];
                    let index = 2;

                    const unit = localStorage.getItem('TempUnit');
                    if (unit != "null" && unit != null) {
                        opts[index] = "unit=" + unit;
                    }

                    let args = opts.join("&");

                    await axios.get("/api/ByTime/temperature?" + args).then(function (result) {
                        out_data = result.data
                    })
                    let indoor_min = 1000, indoor_max = -1000, outdoor_min = 1000, outdoor_max = -1000;
                    for (let idx = 0; idx < out_data.length; idx++) {
                        if (out_data[idx][temp_dims.temp_in] > indoor_max)
                            indoor_max = out_data[idx][temp_dims.temp_in];
                        if (out_data[idx][temp_dims.temp_in] < indoor_min)
                            indoor_min = out_data[idx][temp_dims.temp_in];
                        if (out_data[idx][temp_dims.temp_out] > outdoor_max)
                            outdoor_max = out_data[idx][temp_dims.temp_out];
                        if (out_data[idx][temp_dims.temp_out] < outdoor_min)
                            outdoor_min = out_data[idx][temp_dims.temp_out];
                    }
                    this.option.visualMap[0].max = outdoor_max;
                    this.option.visualMap[0].min = outdoor_min;
                    this.option.visualMap[0].text = [generic_info_trns[target_lang].outdoor + "\r\n" + outdoor_max.toString(), outdoor_min.toString()];
                    this.option.visualMap[1].max = indoor_max;
                    this.option.visualMap[1].min = indoor_min;
                    this.option.visualMap[1].text = [generic_info_trns[target_lang].indoor + "\r\n" + indoor_max.toString(), indoor_min.toString()];

                    this.option.series[0].data = out_data;
                    this.option.series[1].data = out_data;
                    this.$forceUpdate()

                },
                set_translate_objects(trans_name) {
                    this.option.title.text = other_tooltip_translate[trans_name].temp_title;
                    this.$forceUpdate();
                }
            }
    });

    const SolarPict = new Vue({
        el: "#SolarPict",
        data: function () {
            return {
                option: {
                    title: {
                        text: other_tooltip_translate["en"].solar_title,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const cached_trn_name = localStorage.getItem('trn_name');
                            return [
                                echarts.format.formatTime('yyyy-MM-dd', params[0].value[other_dims.time])
                                + ' ' + echarts.format.formatTime('hh:mm', params[0].value[other_dims.time]),
                                other_tooltip_translate[cached_trn_name].solar_tooltip_name + ': ' +
                                params[0].value[other_dims.data_raw_item].toString() + ' W/㎡'
                            ].join('<br>');
                        }
                    },
                    grid: {
                        top: 40,
                        bottom: 60,
                        right: 0
                    },
                    xAxis: {
                        type: 'time'
                    },
                    yAxis: [{
                        name: 'W/㎡',
                        nameLocation: 'middle',
                        nameGap: 35,
                        axisLine: {
                            lineStyle: {
                                color: '#666'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#ddd'
                            }
                        }
                    }, {
                        axisLine: {show: false},
                        axisTick: {show: false},
                        axisLabel: {show: false},
                        splitLine: {show: false}
                    }],
                    dataZoom: [{
                        type: 'inside',
                        xAxisIndex: 0,
                        minSpan: 5
                    }],
                    series: [{
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: other_dims.time,
                            y: other_dims.data_smoothed
                        },
                        lineStyle: {
                            normal: {
                                color: '#ff6a00',
                                type: 'solid'
                            }
                        },
                        smooth: false,
                        data: [],
                        z: 50
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: other_dims.time,
                            y: other_dims.data_raw_item
                        },
                        lineStyle: {
                            normal: {
                                color: '#cbcbcb',
                                type: 'solid'
                            }
                        },
                        smooth: false,
                        data: [],
                        z: 49
                    }]
                }
            }
        },
        methods:
            {
                async fetch_data(startTime, endTime) {
                    const opts = [
                    "startTime=" + startTime,
                    "endTime=" + endTime
                    ];

                    const args = opts.join("&");
                    let out_data;

                    await axios.get("/api/ByTime/solar?" + args).then(function (result) {
                        out_data = result.data
                    });
                    this.option.series[0].data = out_data;
                    this.option.series[1].data = out_data;
                },
                set_translate_objects(trans_name) {
                    this.option.title.text = other_tooltip_translate[trans_name].solar_title;
                    this.$forceUpdate();
                }
            }
    });

    const BaroPict = new Vue({
        el: "#BaroPict",
        data: function () {
            return {
                option: {
                    title: {
                        text: other_tooltip_translate["en"].barometer_title,
                        left: 'center',
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const cached_trn_name = localStorage.getItem('trn_name');
                            return [
                                echarts.format.formatTime('yyyy-MM-dd', params[0].value[baro_dims.time])
                                + ' ' + echarts.format.formatTime('hh:mm', params[0].value[baro_dims.time]),
                                other_tooltip_translate[cached_trn_name].barometer_avg + ': ' +
                                params[0].value[baro_dims.baro].toString() + ' hpa',
                                other_tooltip_translate[cached_trn_name].barometer + ': ' +
                                params[0].value[baro_dims.raw_baro].toString() + ' hpa'
                            ].join('<br>');
                        }
                    },
                    grid: {
                        top: 60,
                        bottom: 60
                    },
                    xAxis: {
                        type: 'time'
                    },
                    yAxis: [{
                        name: 'hPa',
                        nameLocation: 'middle',
                        nameGap: 55,
                        axisLine: {
                            lineStyle: {
                                color: '#666'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#ddd'
                            }
                        },
                        scale: true
                    }, {
                        axisLine: {show: false},
                        axisTick: {show: false},
                        axisLabel: {show: false},
                        splitLine: {show: false}
                    }],
                    visualMap: [{
                        type: 'continuous',
                        align: 'center',
                        left: 'right',
                        top: 'top',
                        orient: 'vertical',
                        itemWidth: 30,
                        itemHeight: 300,
                        text: [],
                        min: 0,
                        max: 30,
                        dimension: baro_dims.baro,
                        inRange: {
                            color: ['#2e2eff', '#ff0000']
                        },
                    }],
                    dataZoom: [{
                        type: 'inside',
                        xAxisIndex: 0,
                        minSpan: 5
                    }],
                    series: [{
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: baro_dims.time,
                            y: baro_dims.baro
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: 'Max', itemStyle: {color: '#ff7300'}},
                                {type: 'min', name: 'Min', itemStyle: {color: '#0486ad'}},
                            ]
                        },
                        smooth: true,
                        data: [],
                        z: 5
                    }, {
                        type: 'line',
                        symbol: 'none',
                        encode: {
                            x: baro_dims.time,
                            y: baro_dims.raw_baro
                        },
                        lineStyle: {
                            color: '#aaaaaa'
                        },
                        smooth: true,
                        data: [],
                        z: 1
                    }
                    ],
                    graphic: [
                        {
                            type: 'text',
                            z: 100,
                            left: '2.5%',
                            top: '3.5%',
                            style: {
                                text: ""
                            }
                        }
                    ]

                }
            }
        },
        methods:
            {
                async fetch_data(start_time, end_time) {
                    let target_lang = localStorage.getItem('trn_name');
                    if (target_lang == "null") {
                        target_lang = "en";
                    }
                    let out_data;
                    const opts = [
                        "startTime=" + start_time,
                        "endTime=" + end_time,
                    ];
                    let index = 2;

                    const altitude = localStorage.getItem('altitude');
                    if (altitude != "null" && altitude != null) {
                        opts[index] = "altitude=" + altitude;
                    }

                    let args = opts.join("&");

                    await axios.get("/api/ByTime/barometer?" + args).then(function (result) {
                        out_data = result.data
                    })
                    let baro_min = 99999, baro_max = -99999;
                    for (let idx = 0; idx < out_data.length; idx++) {
                        if (out_data[idx][baro_dims.baro] > baro_max)
                            baro_max = out_data[idx][baro_dims.baro];
                        if (out_data[idx][baro_dims.baro] < baro_min)
                            baro_min = out_data[idx][baro_dims.baro];
                    }
                    this.option.visualMap[0].max = baro_max;
                    this.option.visualMap[0].min = baro_min;
                    this.option.visualMap[0].text = [other_tooltip_translate[target_lang].barometer + "\r\n" + baro_max.toString() + " hPa", baro_min.toString() + " hPa"];

                    this.option.series[0].data = out_data;
                    this.option.series[1].data = out_data;

                    //this.option.series[0].markPoint.data[2].yAxis = out_data[out_data.length-1][baro_dims.baro];
                    this.option.graphic[0].style.text = other_tooltip_translate[target_lang].current_baro + ": " + out_data[0][baro_dims.raw_baro] + " hPa";
                    //this.option.series[1].data = out_data;
                    this.$forceUpdate()

                },
                set_translate_objects(trans_name) {
                    this.option.title.text = other_tooltip_translate[trans_name].barometer_title;
                    this.$forceUpdate();
                }
            }
    });

    const alt_and_temp_select_obj = new Vue({
        el: "#altitude_input",
        data: {
            trns: {}
        }
    });

    const date_time_select_obj = new Vue({
        el: "#time_selection_overall",
        data: {
            trns: {},
            start_date_time: moment().format('YYYY-MM-DD HH:mm:ss'),
            end_date_time: moment().format('YYYY-MM-DD HH:mm:ss'),
            start_datetime_err_msg: "",
            end_datetime_err_msg: ""
        },
        methods:
            {
                checkdate: function () {
                    let val_now = moment();
                    let val_start = moment(this.start_date_time, 'YYYY-MM-DD HH:mm:ss');
                    let val_end = moment(this.end_date_time, 'YYYY-MM-DD HH:mm:ss');
                    if (val_start.isAfter(val_now)) {
                        this.start_datetime_err_msg = this.trns.start_date_time_alt_text + this.trns.not_later_than + this.trns.today_text;
                        return;
                    }
                    if (val_end.isAfter(val_now)) {
                        this.end_datetime_err_msg = this.trns.end_date_time_alt_text + this.trns.not_later_than + this.trns.today_text;
                        return;
                    }
                    if (val_start.isAfter(val_end)) {
                        this.start_datetime_err_msg = this.trns.start_date_time_alt_text + this.trns.not_later_than + this.trns.end_date_time_alt_text;
                        this.end_datetime_err_msg = this.trns.end_date_time_alt_text + this.trns.not_earlier_than + this.trns.start_date_time_alt_text;
                        return;
                    }
                    if (val_end.diff(val_start, 'hours') > 48) {
                        this.end_datetime_err_msg = this.trns.time_diff_between_text + " 48 " + this.trns.hours_text;
                        return;
                    }
                    this.start_datetime_err_msg = "";
                    this.end_datetime_err_msg = "";
                    update_values(val_start.format("YYYY-MM-DD HH:mm:ss"), val_end.format('YYYY-MM-DD HH:mm:ss'));
                }
            }
    });

    const title_obj = new Vue({
        el: '#time-data-page-link',
        data: {
            trns: {}
        }
    });

    /* ================================
     *       Update Functions
     * ================================ */

    function ChangeLang(object) {
        const target_lang = object.getAttribute('optData');
        const btns = document.getElementsByClassName('lang_lst');
        for (let i = 0; i < btns.length; i++) {
            btns[i].className = 'btn btn-outline-primary lang_lst';
            if (btns[i].getAttribute('optData') === target_lang) {
                btns[i].className += " active";
            }
        }

        localStorage.setItem('trn_name', target_lang);
        wind_analyze.set_translate_objects(target_lang);
        windrose.option.angleAxis.data = wind_angle_list_types[target_lang];
        RainPict.set_translate_objects(target_lang);
        TempPict.set_translate_objects(target_lang);
        SolarPict.set_translate_objects(target_lang);
        BaroPict.set_translate_objects(target_lang);
        alt_and_temp_select_obj.trns = generic_info_trns[target_lang];
        date_time_select_obj.trns = generic_info_trns[target_lang];
        title_obj.trns = generic_info_trns[target_lang];
    }

    function ReadLang() {

        let target_lang = localStorage.getItem('trn_name');
        if (target_lang === "null") {
            target_lang = "en";
        }

        let btns = document.getElementsByClassName('lang_lst');
        for (let i = 0; i < btns.length; i++) {
            btns[i].className = 'btn btn-outline-primary lang_lst';
            if (btns[i].getAttribute('optData') === target_lang) {
                btns[i].className += " active";
            }
        }
        localStorage.setItem('trn_name', target_lang);
        wind_analyze.set_translate_objects(target_lang);
        windrose.option.angleAxis.data = wind_angle_list_types[target_lang];
        RainPict.set_translate_objects(target_lang);
        TempPict.set_translate_objects(target_lang);
        SolarPict.set_translate_objects(target_lang);
        BaroPict.set_translate_objects(target_lang);
        alt_and_temp_select_obj.trns = generic_info_trns[target_lang];
        date_time_select_obj.trns = generic_info_trns[target_lang];
        title_obj.trns = generic_info_trns[target_lang];
    }

    ReadLang();

    function update_values(startTime, endTime) {
        windrose.fetch_data(startTime, endTime);
        wind_analyze.fetch_data(startTime, endTime);
        RainPict.fetch_data(startTime, endTime);
        TempPict.fetch_data(startTime, endTime);
        SolarPict.fetch_data(startTime, endTime);
        BaroPict.fetch_data(startTime, endTime);
        localStorage.setItem('start_time', startTime);
        localStorage.setItem('end_time', endTime);
    }

    function UpdateAltitude(){
        let altitude = Number(document.getElementById('altitude_value_input').value);
        localStorage.setItem('altitude', altitude.toString());
        date_time_select_obj.checkdate();
    }

    function UpdateTempUnit(unit_value){
        localStorage.setItem('TempUnit', unit_value.toString());
        date_time_select_obj.checkdate();
    }

    function ReadAlt() {
        let altitude = localStorage.getItem('altitude');
        if (altitude != "null" && altitude != null && altitude != NaN) {
            document.getElementById('altitude_value_input').value = altitude;
        }
    }

    ReadAlt();

    /* ================================
     *       Timers
     * ================================ */

    //var update_rmap = setInterval(update_values, 10000);

    update_values();

</script>